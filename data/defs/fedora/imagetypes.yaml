---
.common:
  packages:
    - &packages_core
      include:
        - "@core"
        - "systemd-pam"
        - "systemd-networkd"
        - "systemd-networkd-defaults"
        - "teamsbc-release-standard"
        - "dbus"
        - "grubby"
        - "fwupd-efi"
        - "libxkbcommon"
        - "linux-firmware"
      exclude:
        - "NetworkManager"
        - "sssd*"
        - "dracut-config-rescue"
        - "firewalld"
        - "plymouth"
    - &packages_rpi
      include:
        - "bcm283x-firmware"
        - "brcmfmac-firmware"
        # we'd really like this to be only in the build pipeline as it
        # bloats the size of the image quite a bit; needs some upstream
        # work to achieve that
        - "uboot-images-armv8"

  platforms:
    x86_64_uefi_platform: &x86_64_uefi_platform
      arch: "x86_64"
      uefi_vendor: "fedora"
      image_format: "raw"
      qcow2_compat: "1.1"
      packages: &x86_64_uefi_platform_packages
        uefi:
          - "dracut-config-generic"
          - "efibootmgr"
          - "grub2-efi-x64"
          - "shim-x64"
      bootloader: "grub2"
    aarch64_uefi_platform: &aarch64_uefi_platform
      arch: "aarch64"
      uefi_vendor: "fedora"
      image_format: "raw"
      qcow2_compat: "1.1"
      packages: &aarch64_uefi_platform_packages
        uefi:
          - "dracut-config-generic"
          - "efibootmgr"
          - "grub2-efi-aa64"
          - "grub2-tools"
          - "shim-aa64"
      bootloader: "grub2"

  disk_sizes:
    default_required_partition_sizes: &default_required_dir_sizes
      "/": "2 GiB"

  partitioning:
    mbr_ids:
      - &dos_linux_filesystem "83"
      - &dos_fat16 "06"
    gpt_guids:
      - &gpt_efi_system_partition "C12A7328-F81F-11D2-BA4B-00A0C93EC93B"
      - &gpt_generic_linux_data "0FC63DAF-8483-4772-8E79-3D69D8477DE4"
      - &gpt_aarch64_root "b921b045-1df0-41c3-af44-4c6f280d3fae"
      - &gpt_x86_64_root "4f68bce3-e8cd-4db1-96e7-fbcaf984b709"

    # default invidual partitions for easier composibility in the partition
    # tables below
    partition_defaults:
      - &default_efi_partition
        size: "200 MiB"
        type: *gpt_efi_system_partition
        payload_type: "filesystem"
        payload:
          type: vfat
          mountpoint: "/boot/efi"
          label: "ESP"
          fstab_options: "defaults,uid=0,gid=0,umask=077,shortname=winnt"
          fstab_freq: 0
          fstab_passno: 2
      - &default_root_partition
        size: "6 GiB"
        type: *gpt_generic_linux_data
        payload_type: "filesystem"
        payload: &default_partition_table_part_root_payload
          type: "ext4"
          label: "root"
          mountpoint: "/"
          fstab_options: "defaults"
          fstab_freq: 0
          fstab_passno: 0

    virt_partition_tables: &virt_partition_tables
      x86_64:
        type: "gpt"
        partitions:
          - *default_efi_partition
          - <<: *default_root_partition
            type: *gpt_x86_64_root
      aarch64: &default_partition_table_aarch64
        type: "gpt"
        partitions:
          - *default_efi_partition
          - <<: *default_root_partition
            type: *gpt_aarch64_root

    rpi3_rpi02w_partition_tables: &rpi3_rpi02w_partition_tables
      aarch64:
        type: "dos"
        partitions:
          - size: "200 MiB"
            type: *dos_fat16
            payload_type: "filesystem"
            payload:
              type: "vfat"
              mountpoint: "/boot/efi"
              label: "ESP"
              fstab_options: "defaults,uid=0,gid=0,umask=077,shortname=winnt"
              fstab_freq: 0
              fstab_passno: 2
          - size: "6 GiB"
            type: *dos_linux_filesystem
            payload_type: "filesystem"
            payload: &default_partition_table_part_root_payload
              type: "ext4"
              label: "root"
              mountpoint: "/"
              fstab_options: "defaults"
              fstab_freq: 0
              fstab_passno: 0

    rpi4_partition_tables: &rpi4_partition_tables
      aarch64: *default_partition_table_aarch64

image_config:
  default:
    default_oscap_datastream: "/usr/share/xml/scap/ssg/content/ssg-fedora-ds.xml"
    hostname: "localhost.localdomain"
    install_weak_deps: false
    install_langs:
      - "C"
    locale: "C.UTF-8"
    machine_id_uninitialized: true
    mount_units: true
    kernel_options:
      - "rw"
    default_kernel: "kernel-core"
    update_default_kernel: true
    grub2_config:
      timeout: 5
    enabled_services:
      - "sshd.service"
    authselect:
      profile: "local"
      features:
        - "with-silent-lastlog"
        - "with-systemd-homed"

image_types:
  "standard-virt":
    filename: "disk.raw.xz"
    compression: "xz"
    mime_type: "application/xz"
    bootable: true
    default_size: "1 GiB"
    image_func: "disk"
    exports: ["xz"]
    required_partition_sizes: *default_required_dir_sizes
    package_sets:
      os:
        - *packages_core
    partition_table: *virt_partition_tables
    platforms:
      - <<: *x86_64_uefi_platform
        image_format: "raw"
      - <<: *aarch64_uefi_platform
        image_format: "raw"

  "standard-rpi02w":
    filename: "disk.raw.xz"
    compression: "xz"
    mime_type: "application/xz"
    bootable: true
    default_size: "1 GiB"
    image_func: "disk"
    exports: ["xz"]
    required_partition_sizes: *default_required_dir_sizes
    package_sets:
      os:
        - *packages_core
        - *packages_rpi
    partition_table: *rpi3_rpi02w_partition_tables
    platforms:
      - <<: *aarch64_uefi_platform
        image_format: "raw"
        boot_files:
          - ["/usr/share/uboot/rpi_arm64/u-boot.bin", "/boot/efi/rpi-u-boot.bin"]

  "standard-rpi3":
    filename: "disk.raw.xz"
    compression: "xz"
    mime_type: "application/xz"
    bootable: true
    default_size: "1 GiB"
    image_func: "disk"
    exports: ["xz"]
    required_partition_sizes: *default_required_dir_sizes
    package_sets:
      os:
        - *packages_core
        - *packages_rpi
    partition_table: *rpi3_rpi02w_partition_tables
    platforms:
      - <<: *aarch64_uefi_platform
        image_format: "raw"
        boot_files:
          - ["/usr/share/uboot/rpi_arm64/u-boot.bin", "/boot/efi/rpi-u-boot.bin"]

  "standard-rpi4":
    filename: "disk.raw.xz"
    compression: "xz"
    mime_type: "application/xz"
    bootable: true
    default_size: "1 GiB"
    image_func: "disk"
    exports: ["xz"]
    required_partition_sizes: *default_required_dir_sizes
    package_sets:
      os:
        - *packages_core
        - *packages_rpi
    partition_table: *rpi4_partition_tables
    platforms:
      - <<: *aarch64_uefi_platform
        image_format: "raw"
        boot_files:
          - ["/usr/share/uboot/rpi_arm64/u-boot.bin", "/boot/efi/rpi-u-boot.bin"]
